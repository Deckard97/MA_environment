[global_tags]

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "5s"
  flush_interval = "10s"
  flush_jitter = "5s"
  omit_hostname = true

## OUTPUT PLUGINS
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "3gH3gJHl6d2QhwkRpPslL2g8UHt7H3kNj3KlN2jN2K"
  organization = "testenv"
  bucket = "metricdb"

## INPUT PLUGINS
# MySQL/MariaDB
[[inputs.mysql]]
  servers = ["root:root@tcp(db:3306)/"]

# Apache
[[inputs.apache]]
  urls = ["http://httpd/server-status?auto"]

# Docker
[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"
  timeout = "5s"
  container_name_include = [
    "httpd", 
    "app1", 
    "app2",
    "db"
  ]
  tagexclude = ["com.docker.compose.*"]

# Spring Boot Actuator Prometheus Metrics
[[inputs.prometheus]]
  urls = [
    "http://app1:8080/actuator/prometheus",
    # "http://app2:8080/actuator/prometheus"
  ]
  metric_version = 2
  interval = "10s"
  response_timeout = "5s"

# Service health
[[inputs.http]]
  urls = ["http://httpd/actuator/health"]
  data_format = "json_v2"
  
  [[inputs.http.json_v2]]
    measurement_name = "service_health"
    
    [[inputs.http.json_v2.field]]
      path = "status"

# HTTPD 5xx responses
[[inputs.http]]
  urls = ["http://elasticsearch:9200/.ds-filebeat-8.10.2-*/_search"]
  method = "POST"
  headers = {"Content-Type" = "application/json"}
  data_format = "json_v2"

  body = '''
  {
    "size": 0,
    "query": {
      "bool": {
        "must": [
          { "range": { "http.response.status_code": { "gte": 500, "lte": 599 } }},
          { "term": { "event.dataset": "apache.access" }}
        ],
        "filter": [
          { "range": { "@timestamp": { "gte": "now-5m", "lte": "now" }}}
        ]
      }
    }
  }
  '''
  
  [[inputs.http.json_v2]]
    measurement_name = "log_metrics"
    [[inputs.http.json_v2.field]]
      path = "hits.total.value"
      rename = "5xx_responses_5m"

# Error Rate Application
[[inputs.http]]
  urls = ["http://elasticsearch:9200/.ds-filebeat-8.10.2-*/_search"]
  method = "POST"
  headers = {"Content-Type" = "application/json"}
  data_format = "json_v2"

  body = '''
  {
    "size": 0,
    "query": {
      "bool": {
        "must": [
          { "term": { "event.dataset": "springboot.logs" }},
          { "term": { "log.level": "ERROR" }}
        ],
        "filter": [
          { "range": { "@timestamp": { "gte": "now-5m", "lte": "now" }}}
        ]
      }
    }
  }
  '''
  
  [[inputs.http.json_v2]]
    measurement_name = "log_metrics"
    [[inputs.http.json_v2.field]]
      path = "hits.total.value"
      rename = "app_5m_error_rate"

# Error Rate MYSQL
[[inputs.http]]
  urls = ["http://elasticsearch:9200/.ds-filebeat-8.10.2-*/_search"]
  method = "POST"
  headers = {"Content-Type" = "application/json"}
  data_format = "json_v2"

  body = '''
  {
    "size": 0,
    "query": {
      "bool": {
        "must": [
          { "term": { "event.dataset": "mysql.error" }},
          { "term": { "log.level": "Error" }}
        ],
        "filter": [
          { "range": { "@timestamp": { "gte": "now-10m", "lte": "now" }}}
        ]
      }
    } 
  }
  '''
  
  [[inputs.http.json_v2]]
    measurement_name = "log_metrics"
    [[inputs.http.json_v2.field]]
      path = "hits.total.value"
      rename = "db_10m_error_rate"

# Slow requests MYSQL
[[inputs.http]]
  urls = ["http://elasticsearch:9200/.ds-filebeat-8.10.2-*/_search"]
  method = "POST"
  headers = {"Content-Type" = "application/json"}
  data_format = "json_v2"

  body = '''
  {
    "size": 0,
    "query": {
      "bool": {
        "must": [
          { "term": { "event.dataset": "mysql.slowlog" }}
        ],
        "filter": [
          { "range": { "@timestamp": { "gte": "now-5m", "lte": "now" }}}
        ]
      }
    }
  }
  '''
  
  [[inputs.http.json_v2]]
    measurement_name = "log_metrics"
    [[inputs.http.json_v2.field]]
      path = "hits.total.value"
      rename = "db_5m_slow_rate"